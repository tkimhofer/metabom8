<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data Import and Preprocessing • metabom8</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data Import and Preprocessing">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metabom8</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/MVA.html">Multivariate Analysis and Metabolite ID-ing</a></li>
    <li><a class="dropdown-item" href="../articles/PreProc.html">Data Import and Preprocessing</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tkimhofer/metabom8/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Data Import and Preprocessing</h1>
                        <h4 data-toc-skip class="author">Torben
Kimhofer</h4>
            
            <h4 data-toc-skip class="date">2025-08-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tkimhofer/metabom8/blob/HEAD/vignettes/PreProc.Rmd" class="external-link"><code>vignettes/PreProc.Rmd</code></a></small>
      <div class="d-none name"><code>PreProc.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="data-import-quality-control-and-spectral-pre-processing">Data import, quality control and spectral pre-processing<a class="anchor" aria-label="anchor" href="#data-import-quality-control-and-spectral-pre-processing"></a>
</h2>
<p> </p>
<p>This tutorial runs through a typical data import and pre-processing
workflow for Magnetic Resonance spectroscopy (MRS) - based metabolic
profiling with the <em>metabom8</em> R package. Tutorial data are
available in the <em>nmrData</em> R package. Both of these packages are
available on the author’s GitHub page and can be installed using the
commands below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tkimhofer.github.io/metabom8/">metabom8</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gforge.se/packages/" class="external-link">htmlTable</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<p> </p>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>Proton (<sup>1</sup>H) NMR data are available in the <em>nmrData</em>
package (www.github.com/tkimhofer) and constitute standard 1D
experiments acquired from murine urine samples. Samples were collected
longitudinally with a single collection point before and multiple
collection points after bariatric surgery was performed. Data
acquisition was performed on a 600 MHz Bruker Avance III spectrometer,
equipped with a 5 mm triple resonance (TXI) probe operating at 300 K.
Further information on study design, experimental setup and data
collection can be found in Jia Li <em>et al.</em><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Li, Jia V., &lt;em&gt;et al.&lt;/em&gt; (2011) Metabolic surgery
profoundly influences gut microbial-host metabolic cross-talk.
&lt;em&gt;Gut&lt;/em&gt; 60.9, 1214-1223.&lt;/p&gt;"><sup>1</sup></a></p>
<p> </p>
</div>
<div class="section level3">
<h3 id="import-of-nmr-spectra-and-metadata">Import of NMR spectra and metadata<a class="anchor" aria-label="anchor" href="#import-of-nmr-spectra-and-metadata"></a>
</h3>
<p>The <strong><code><a href="../reference/read1d.html">read1d_proc()</a></code></strong> function imports
Bruker NMR spectra into the R workspace. The function requires at
minimum two input arguments: * <code>path</code>: path to the directory
that encloses NMR experiments * <code>exp_type</code>: list of
spectrometer parameters to select desired experiment types.</p>
<p>In this tutorial all standard 1D experiments are imported. The
selection parameter is based on the pulse sequence name:
<code>PULPROG='noesypr1d'</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define path to NMR experiments</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/"</span>, package <span class="op">=</span> <span class="st">"nmrdata"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># import 1D NMRS data</span></span>
<span><span class="fu"><a href="../reference/read1d.html">read1d_proc</a></span><span class="op">(</span><span class="va">path</span>, exp_type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PULPROG<span class="op">=</span><span class="st">'noesypr1d'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>By default, the variables X, ppm, and meta are exported into the
global R workspace and can be accessed directly after running
read1d_proc().</p>
<p>The rownames of <em>X</em> indicate the folder location of individual
experiments, which can further be used to match sample annotation data
(e.g., group-memberships). The dataframe <em><code>meta</code></em> is
row-matched to the NMR data matrix (<em><code>X</code></em>) and
contains information relating to spectrometer acquisition and TopSpin
software processing parameters, including the acquisition date. See
<code>?read1d()</code> for more information.</p>
<p> </p>
</div>
<div class="section level3">
<h3 id="visualisation-of-nmr-spectra">Visualisation of NMR spectra<a class="anchor" aria-label="anchor" href="#visualisation-of-nmr-spectra"></a>
</h3>
<div class="section level4">
<h4 id="basic-plotting">Basic plotting<a class="anchor" aria-label="anchor" href="#basic-plotting"></a>
</h4>
<p>Plotting functions for visualising NMR spectra include
<strong><code><a href="../reference/spec.html">spec()</a></code></strong> and
<strong><code><a href="../reference/matspec.html">matspec()</a></code></strong>.
<strong><code><a href="../reference/spec.html">spec()</a></code></strong> can be used to plot a single
spectrum. <strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> can be used to overlay
multiple spectra. By default, both functions produce interactive line
graphs based on <em>plotly</em>. However, due to formatting issues this
tutorial will produce static graphics throughout (this is achieved by
the function argument to <code>interactive=FALSE</code>). Please feel
free to use interactive plot versions (just remove argument
<code>interactive=FALSE</code>) as these often provide easier access to
the data.</p>
<p>Example script for plotting NMR spectra:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># use 'spec' to plot a single spectrum, e.g., in row position 15:</span></span>
<span><span class="fu"><a href="../reference/spec.html">spec</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="fl">15</span>,<span class="op">]</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use 'matspec' to overlay spectra, in ppm range 0 to 10</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1.7</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>From this overview we can see that the spectral width ranges from -5
to approximately 15 ppm with the residual water signal resonating around
4.8 ppm. All <sup>1</sup>H NMR signals are situated within the ppm range
of 0 and 10, therefore both ends can be capped and this will be
illustrated further below.</p>
</div>
<div class="section level4">
<h4 id="ggplot2">ggplot2<a class="anchor" aria-label="anchor" href="#ggplot2"></a>
</h4>
<p>There are different higher-level plotting functions available that
allow more comprehensive plot formatting. These functions are based on
the <em>ggplot2</em> package. One of these functions is
<strong><code><a href="../reference/specOverlay.html">specOverlay()</a></code></strong>, which is comparable to
<strong><code><a href="../reference/matspec.html">matspec()</a></code></strong> shown above, but enables to
create different subplots (aka facetting) and to include colour scales
and linetypes in a straightforward way.</p>
<div class="section level5">
<h5 id="function-argument-an">Function argument <em>an</em><a class="anchor" aria-label="anchor" href="#function-argument-an"></a>
</h5>
<p>Plot formatting using colour, text labels and sub-divisions can
create insight into the data. In ggplot-based plotting functions of
<em>metabom8</em>, these formatting options are passed a list element to
the function argument <em>an</em>. The order in which the plotting
parameters are provided matters and has the form:
<code>an=list([facet], [colour], [linetype])</code>, whereas each list
element is a vector with as many elements as there are spectra (=rows)
in <em>X</em>.</p>
<p>For illustration purposes, the following code plot the TSP singlet
(-0.05 to 0.05 ppm) and annotate spectra with information on
spectrometer metadata (found in the <em>meta</em> dataframe). One panel
is created for each experiment type, the line colour represents the
instrument run order (this is based on the acquisition <em>a_Date</em>)
and the linetype indicates the NMR pulse program
(<em>a_PULPROG</em>):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create run-order based on acquistion date</span></span>
<span><span class="va">meta</span><span class="op">$</span><span class="va">runOrder</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">meta</span><span class="op">$</span><span class="va">a_DATE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot TSP signal</span></span>
<span><span class="fu"><a href="../reference/specOverlay.html">specOverlay</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span><span class="op">)</span>, </span>
<span>    an<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="st">'Facet'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">a_EXP</span>, <span class="co"># facet</span></span>
<span>             <span class="st">'RunOrder'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">runOrder</span>, <span class="co"># colour</span></span>
<span>             <span class="st">'Pulse Program'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">a_PULPROG</span><span class="op">)</span> <span class="co"># linetype</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>The plot above shows that two different experiment types were
performed (i.e., two different panels), both based on the pulse program
<em>&lt;noesypr1d&gt;</em>, which a Bruker term for a standard 90˚ pulse
experiment with water pre-saturation. Experiment types labelled
<em>&lt;&gt;</em> are calibration experiments and were performed before
<em>&lt;JL-noe1D&gt;</em> were acquired (see Date information, i.e., run
order).</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="chemical-shift-calibration">Chemical shift calibration<a class="anchor" aria-label="anchor" href="#chemical-shift-calibration"></a>
</h3>
<p>Chemical shift calibration refers to a horizontal shift of an entire
spectrum to place a signal of a standard compound at a defined chemical
shift position. In urine metabolic profiling, the standard compound is
TSP<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;3-(trimethylsilyl)-2,2′,3,3′-tetradeuteropropionic
acid&lt;/p&gt;"><sup>2</sup></a>
(usually added to the sample buffer), which gives rise to a singlet that
is defined to resonate at 0 ppm.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Dona, A.C., &lt;em&gt;et al.&lt;/em&gt; (2014) Precision
high-throughput proton NMR spectroscopy of human urine, serum, and
plasma for large-scale metabolic phenotyping. &lt;em&gt;Analytical
Chemistry&lt;/em&gt;. 86.19. 9887-94.&lt;/p&gt;"><sup>3</sup></a></p>
<p>We can reference the urine spectra using the
<strong><code><a href="../reference/calibrate.html">calibrate()</a></code></strong> function, as shown with the
following code:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># perform TSP calibration</span></span>
<span><span class="va">X_cal</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">ppm</span>, type<span class="op">=</span><span class="st">'tsp'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot TSP after calibration</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_cal</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>After calibration of the urine spectra, the TSP peak apex is centered
at zero ppm.</p>
<p> </p>
</div>
<div class="section level3">
<h3 id="filtering-based-on-spectrometer-parameters">Filtering based on spectrometer parameters<a class="anchor" aria-label="anchor" href="#filtering-based-on-spectrometer-parameters"></a>
</h3>
<p>For statistical analysis all calibration experiments are to be
excluded and only standard 1D experiments are kept
(<em>&lt;JL-noe1d&gt;</em>). Filtering can be performed using the
following code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Exclude calibration experiments</span></span>
<span><span class="va">idx</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">'noe1d'</span>, <span class="va">meta</span><span class="op">$</span><span class="va">a_EXP</span><span class="op">)</span> </span>
<span><span class="va">X_cal</span><span class="op">&lt;-</span><span class="va">X_cal</span><span class="op">[</span><span class="va">idx</span>,<span class="op">]</span></span>
<span><span class="va">meta</span><span class="op">&lt;-</span><span class="va">meta</span><span class="op">[</span><span class="va">idx</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># plot TSP signal</span></span>
<span><span class="fu"><a href="../reference/specOverlay.html">specOverlay</a></span><span class="op">(</span><span class="va">X_cal</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.05</span>,<span class="fl">0.05</span><span class="op">)</span>, </span>
<span>    an<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="st">'Facet'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">a_EXP</span>, <span class="co"># facet</span></span>
<span>             <span class="st">'Receiver Gain'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">a_RG</span>, <span class="co"># colour</span></span>
<span>             <span class="st">'Pulse Program'</span><span class="op">=</span><span class="va">meta</span><span class="op">$</span><span class="va">a_PULPROG</span><span class="op">)</span> <span class="co"># linetype</span></span>
<span>    <span class="op">)</span> <span class="co"># linetype</span></span></code></pre></div>
<p> </p>
</div>
<div class="section level3">
<h3 id="assessment-of-spectral-quality">Assessment of spectral quality<a class="anchor" aria-label="anchor" href="#assessment-of-spectral-quality"></a>
</h3>
<p>In metabolic phenotyping and in any other field where NMR spectra are
compared in a quantitative fashion, the quality of spectra is of
particular importance. Spectral quality assessment includes visual
inspection of the water suppression quality, peak symmetry, spectral
linewidths, baseline level and stability as well as the average signal
to noise (SN) ratio.</p>
<p>Visual assessment of spectral quality:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate quality control measures</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_cal</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.5</span>,<span class="fl">5</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">'Residual Water'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_cal</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">11</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">'LowField Cap'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_cal</span>, <span class="va">ppm</span>, shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span>, main<span class="op">=</span><span class="st">'UpField Cap'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  </span></code></pre></div>
<p> </p>
</div>
<div class="section level3">
<h3 id="excision-of-signals">Excision of signals<a class="anchor" aria-label="anchor" href="#excision-of-signals"></a>
</h3>
<p>Further downstream analysis requires the excision of chemical shift
regions bearing no biological or non-quantitative information. In
urinary NMR analyses this includes the TSP signal, the residual water
and urea signal as well as ppm regions where there is no signal but only
noise.</p>
<p>The function <strong><code><a href="../reference/get_idx.html">get_idx()</a></code></strong> can be used to
obtain indices of the desired shift range from the ppm vector. These
indices can then be further used to exclude the relevant columns in the
NMR matrix and ppm vector. This is illustrated in the following code
snippet.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Indexing TSP region and upfield noise...</span></span>
<span><span class="va">idx_tsp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_idx.html">get_idx</a></span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="va">ppm</span><span class="op">)</span></span>
<span><span class="co"># ... water region...</span></span>
<span><span class="va">idx_water</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_idx.html">get_idx</a></span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.6</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">ppm</span><span class="op">)</span></span>
<span><span class="co"># ... as well as downfield noise regions</span></span>
<span><span class="va">idx_noise</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/get_idx.html">get_idx</a></span><span class="op">(</span>range<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span><span class="op">)</span>, <span class="va">ppm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idx_rm</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">idx_tsp</span>, <span class="va">idx_water</span>, <span class="va">idx_noise</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Excision of TSP, residual water signal and noise regions</span></span>
<span><span class="va">X_cut</span><span class="op">&lt;-</span><span class="va">X_cal</span><span class="op">[</span>,<span class="op">-</span><span class="va">idx_rm</span><span class="op">]</span></span>
<span><span class="va">ppm</span><span class="op">&lt;-</span><span class="va">ppm</span><span class="op">[</span><span class="op">-</span><span class="va">idx_rm</span><span class="op">]</span></span></code></pre></div>
<p> </p>
</div>
<div class="section level3">
<h3 id="baseline-correction">Baseline correction<a class="anchor" aria-label="anchor" href="#baseline-correction"></a>
</h3>
<p>Macromolecules such as proteins produce broad resonances in an NMR
spectrum, these are termed spectral baselines. Baseline differences
across spectra can produce artifacts, and a spectra are typically
baseline corrected to more accurate results. In <em>metabom8</em>, the
<strong><code><a href="../reference/bline.html">bline()</a></code></strong> implements a non-linear baseline
correction using asymmetric least squares. See the example below on how
to apply this function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Baseline correction</span></span>
<span><span class="va">X_bl</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/bline.html">bline</a></span><span class="op">(</span><span class="va">X_cut</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visual assessment</span></span>
<span><span class="va">Xcompare</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">X_bl</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">X_cut</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">Xcompare</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">9</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">Xcompare</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The black line is the baseline corrected spectrum, the red and dotted
line represents the uncorrected spectrum.  </p>
</div>
<div class="section level3">
<h3 id="spectral-normalisation">Spectral normalisation<a class="anchor" aria-label="anchor" href="#spectral-normalisation"></a>
</h3>
<p>Depending on the sample type, spectra may require normalisation prior
to statistical analysis. For example, the signal strength in different
urine samples can vary substantially, mainly related to the uptake of
different amounts of water. Normalisation methods can account for these
kind of dilution sensitivity.</p>
<p>There are several normalisation methods available, which method is
most suitable depends on the sample type and experimental setup. Among
the most commonly applied ones are Total Area (TA) normalisation and
Probabilistic Quotient Normalisation (PQN).<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Dieterly, F., (2006), Probabilistic Quotient
Normalization as Robust Method to Account for Dilution of Complex
Biological Mixtures. Application in 1H NMR Metabonomics, , 78.3,
4281-90&lt;/p&gt;"><sup>4</sup></a> In this tutorial,
spectra are normalised with the PQN method
(<strong><code><a href="../reference/pqn.html">pqn()</a></code></strong>).</p>
<p>The function <strong><code><a href="../reference/pqn.html">pqn()</a></code></strong> requires at least
one input, which is the NMR matrix to be normalised
(<strong>X_bl</strong>), the output of this function will be the PQN
normalised data matrix. In the code below, there is one additional input
argument provided (<em>add_DilF = ‘dilf’</em>), which indicates that the
calculated dilution factors should be exported to the R workspace as an
array named <em>dilf</em>. Checking the dilution factors can be very
informative. For example, if pooled quality control samples were
periodically included in the study run, then these should have very
comparable dilution factors.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># PQN normalisation</span></span>
<span><span class="va">X_pqn</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/pqn.html">pqn</a></span><span class="op">(</span><span class="va">X_bl</span>, add_DilF <span class="op">=</span> <span class="st">'dilf'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualising the pqn dilution coefficient / scaling factor for each spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">dilf</span>, xlab<span class="op">=</span><span class="st">'PQN calculated dilution factor'</span><span class="op">)</span></span></code></pre></div>
<p>The final step in this preprocessing tutorial is the visual
inspection of the pre-processed NMR spectra:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_pqn</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">ppm</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matspec.html">matspec</a></span><span class="op">(</span><span class="va">X_pqn</span>, <span class="va">ppm</span>, shift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1.7</span><span class="op">)</span>, interactive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p> </p>
</div>
</div>
<div class="section level2">
<h2 id="summary-and-further-steps">Summary and further steps<a class="anchor" aria-label="anchor" href="#summary-and-further-steps"></a>
</h2>
<p>1D NMR spectra were imported, quality checked and pre-processed which
included referencing to TSP, baseline correction, excision of spectral
areas that bear no quantitative biological information. Urinary spectra
were normalised with PQN to account for different sample dilutions.</p>
<p>The pre-processed spectra can now be statistically interrogated,
e.g., using multivariate methods Principal Component Analysis (PCA) and
Orthogonal-Partial Least Squares (O-PLS). You can find more information
on this in the vignette <strong>Multivariate Statistical
Analysis</strong>.</p>
<div class="section level3">
<h3 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h3>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Torben Kimhofer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
