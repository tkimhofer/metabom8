---
title: "Multivariate Analysis and Metabolite ID-ing"
author: "Torben Kimhofer"
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Multivariate Analysis and Metabolite ID-ing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = requireNamespace("nmrdata", quietly = TRUE)
)

has_data <- requireNamespace("nmrData", quietly = TRUE)
```

```{r no-data-msg, echo = FALSE, results = "asis"}
if (!has_data) {
  cat("## Tutorial Unavailable\n\nThis vignette requires the external package **nmrData** and access to large raw NMR datasets, which are not shipped with this package due to their size.\n\nTo run the full tutorial locally, please install `nmrData` from GitHub:\n\n```r\nremotes::install_github(\"tkimhofer/nmrData\")\n```\n")
}
```

# Multivariate statistical analysis

This tutorial illustrates a multivariate statistical analysis workflow for NMR-based metabolic profiling using the *metabom8* R package.

```{r load-pack, message=FALSE, warning=FALSE}
# load packages
if (!requireNamespace("nmrData", quietly = TRUE)) {
  remotes::install_github("tkimhofer/nmrData")
}
library(metabom8)
library(nmrdata)
```

## Example Data

Proton (^1^H) NMR data are available in the *nmrData* package (www.github.com/tkimhofer) and constitute standard 1D experiments acquired from murine urine samples. Information on experimental setup and NMR data acquisition can be found in the original publication^[Li, Jia V., *et al.* (2011) Metabolic surgery profoundly influences gut microbial-host metabolic cross-talk. *Gut* 60.9, 1214-1223.]. Here, pre-processed data are imported. 
```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
# Load data
data(bariatric)

# Declare variables
Xn<-bariatric$X.pqn # PQN-normalised NMR data matrix
dim(Xn)

ppm<-bariatric$ppm     # chemical shift vector in ppm
length(ppm)

meta<-bariatric$meta   # spectrometer metadata
dim(meta)

an<-bariatric$an       # sample annotation
dim(an)

```
The following variables should be in the R workspace after executing the code snippet below:

* *Xn* - preprocessed NMR data matrix where rows represent spectra and columns represent ppm variables
* *ppm*   - chemical shift vector in part per million (ppm), it's length equals to the number of columns of Xn *length(ppm)==ncol(Xn)*
* *an*    - sample annotation data frame containing information about each sample (e.g. group membership, confounder variables)
* *meta*  - spectrometer metadata, e.g., probe temperature at acquisition (not essential for this tutorial)


## Interactive visualisation of NMR spectra
The following plotly-based functions are available to visualise and browse NMR spectra interactively:

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
spec(Xn[1,], ppm, shift = c(0,10)) # singe spectrum, interactive
matspec(Xn[1:10,], ppm, shift = c(0.8, 1))  # spectral overlay, interactive
```


## PCA - Unsupervised Analysis
In `metabom8`, Principal Component Analysis (PCA) can be performed using the  `pca()` function. This function takes the preprocessed NMR matrix (X = Xn), the desired number of principal components (pc = 2), and optional centering and scaling parameters (e.g., center = TRUE, scale = "UV" for unit variance scaling).

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
# Perform PCA
pca_model=pca(X=Xn, pc=2, scale='UV', center=TRUE)
```

The returned object, *pca_model*, is a structured S3 object containing model information such as:

- t – scores matrix (projections of samples onto each PC)
- p – loadings matrix (variable contributions to each PC)
- $R^2X$ – explained variance per component
- other internal diagnostics

### Why use `metabom8::pca()`? 
Unlike generic PCA functions (e.g., `prcomp()`), `metabom8::pca()` returns an object fully compatible with the rest of the `metabom8` ecosystem. This allows:
- Streamlined model visualisation using helper functions like plotscores() and plotload()
- Consistent aesthetics and annotations (e.g., point grouping, labelling)
- Reusability of the PCA object for further interpretation and diagnostics
- Simplified code flow for multivariate chemometric pipelines

### Visualising PCA Results
The pca() function in 'metabom8' returns a structured PCA model, directly compatible with downstream visualisation functions. Use `plotscores()` for scores plots and `plotload()` for loadings.

```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
# Scores plot with colouring by class membership
plotscores(
  obj = pca_model,
  pc = c(1, 2),
  an = list(Surgery = an$Class),
  title = "PCA - Scores Plot"
)

# Loadings plot for the first two PCs
plotload(pca_model, pc = 1)
plotload(pca_model, pc = 2)
```

Each point in the scores plot represents a sample. Axis labels show explained variance ($R^2$), and the dotted ellipse denotes Hotelling’s $T^2$ for outlier detection.

Aesthetic mapping (colour, shape, labels) is flexible via the `an` list:

```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
# define scores that should be labelled
idx<-which(pca_model@t[,2]>20 & an$Class=='RYGB') # PC 2 scores above 20 and in group RYGB

# construct label vector with mouse IDs
outliers <- rep("", nrow(an)); outliers[idx] <- an$ID[idx]

# Plot PCA scores, colour according to class, point shape according to time of sample collection and label outliers
plotscores(
  obj=pca_model, 
  pc=c(1,2), 
  an=list(
    Class=an$Class,         # point colour
    Timepoint=an$Timepoint, # point shape
    ID=outliers             # point label
  ),  
  title='PCA - Scores plot')
```
Loadings are visualised as line plots resembling NMR spectra. They reveal variable contributions to each PC:

```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
# Focused loadings plot of PC 2 (aromatic region)
plotload(pca_model, pc = 2, shift = c(6, 9))
```
The x-axis shows chemical shift (ppm); the y-axis reflects loading magnitude; colour indicates normalised importance. Loadings and scores are linked—peaks with warm colours correspond to sample trends in the scores plot.


## Supervised Analysis with O-PLS
While PCA revealed clustering by treatment group, it does not explicitly model group differences. To directly associate spectral variation with an outcome, we use Orthogonal Partial Least Squares (O-PLS), implemented via `opls()` in metabom8.

O-PLS decomposes the NMR matrix $X$ into:
- a predictive component aligned with the outcome variable $Y$
- one or more orthogonal components capturing structured variation unrelated to $Y$

This separation improves model interpretability and helps isolate biologically meaningful variation.

### Model Training
```{r, fig.show='hold', fig.width = 7.2, fig.height = 4, message=FALSE, warning=FALSE}
# Exclude pre-op group
idx<-an$Class!='Pre-op'
X<-Xn[idx,]
Y<-an$Class[idx]

# Train O-PLS model
opls.model<-opls(X,Y)
```
The model summary plot displays configurations tested (e.g., 1+1 predictive+orthogonal components). The selected model minimizes overfitting using internal cross-validation.

```{r, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
summary(opls.model)
```
- $R^2X$: proportion of variance explained in the predictor matrix (X)
- $R^2Y$: proportion of variance explained in the outcome variable (Y)
- $Q^2$ / $AUROC_{CV}$: cross-validated prediction accuracy

### Overfitting & Component Selection
O-PLS models can underfit (too few orthogonal components) or overfit (too many, capturing noise). `metabom8` uses automatic selection based on:

- $Q^2$  (for continuous Y)
- $AUROC_{CV}$ (for categorical Y)

### Model Diagnostics
Use `dmodx()` to assess outliers based on distance to the model in X-space (DModX):
```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
distX=dmodx(mod =opls.model, plot=TRUE)
```
Samples above the 95% confidence line warrant inspection.

### Visualising O-PLS Scores and Loadings
Scores plots summarise group separation. `plotscores()` includes options for aesthetics and cross-validated scores:

```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
# Plot OPLS scores
plotscores(obj=opls.model, an=list(
  Surgery=an$Class[idx],          # colouring according to surgery type
  Timepoint=an$Timepoint[idx]),   # linetype according to timepoint
  title='OPLS - Scores plot',     # plot title
  cv.scores = TRUE)                  # visualise cross-validated scores
```
The predictive component is along the x-axis. The orthogonal component (y-axis) is unrelated to the outcome and often reflects technical variation (e.g., batch or normalisation effects).

### Variable Importance: Loadings & Spectral Mapping
Use `plotload()` to visualise variable contributions:
```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
plotload(opls.model, title = 'OPLS-DA Loadings', shift = c(0.5, 9.5))
```
Backscaled loadings map effects onto spectral units:

```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
plotload(opls.model, type = "backscaled", title = "Backscaled Loadings", shift = c(0.5, 9.5))
```
Overlay backscaled loadings with group spectra using `specload()`:
```{r, fig.show='hold', fig.width = 7.2, fig.height = 5, message=FALSE, warning=FALSE}
specload(mod=opls.model, shift=c(7.3,7.45), an=list(
  facet=an$Class[idx]), 
  type='backscaled', 
  alp = 0.5, 
  title = 'Overlayed Spectra with Backscaled Loadings')
```
This reveals that signals at ~7.365 and ~7.425 ppm are stronger in the RYGB group, indicating their role in group separation.



# Metabolite Identification
Once important variables are identified through supervised modeling (e.g., O-PLS), the next step is to group co-varying signals that may originate from the same metabolite.

## Statistical Total Correlation Spectroscopy (STOCSY)
Metabolites often give rise to multiple resonances in NMR spectra. STOCSY is a correlation-based method that helps identify structurally related peaks, aiding compound annotation.

```{r, fig.show='hold', fig.width = 7.2, fig.height = 5, message=FALSE, warning=FALSE}
# define driver peak (the ppm variable where all other spectral variables will be correlated to)
driver1<-7.834
# perform stocsy
stocsy_model<-stocsy(Xn, ppm, driver1) 
# zoom-in different plot regions
plotStocsy(stocsy_model, shift=c(7,8))
plotStocsy(stocsy_model, shift=c(3.9, 4))
```
From the STOCSY plot, you may observe multiple correlated peaks:
- Multiplet @ 7.56 ppm
- Multiplet @ 7.65 ppm
- Doublet @ 7.84 ppm
- Doublet @ 3.97 ppm
These co-varying signals suggest they originate from the same compound.

### Spectral Database Query
Identified peak patterns can be queried against spectral reference databases to propose metabolite identities.

To query HMDB:

1. Go to www.hmdb.ca
2. Use the NMR search tool
3. Enter the chemical shifts (e.g., 7.84, 7.65, 7.56, 3.97)
4. Set a tolerance (e.g., ±0.01 ppm)

This provides a shortlist of candidate metabolites based on spectral matches.

```{r, fig.show='hold', fig.width = 6, fig.height = 5, message=FALSE, warning=FALSE}
cat("> **Note:** This method provides only a preliminary compound suggestion. Further NMR validation is recommended.\n\n")
```


# Summary
This vignette introduced a chemometric workflow for NMR-based metabolic phenotyping using the metabom8 package. Key steps included:
- Dimensionality reduction with PCA to visualise global trends
- Supervised modeling with O-PLS to isolate treatment-associated variation
- Visualisation of scores and loadings to interpret variable contributions
- Identification of outliers and orthogonal structure via diagnostics
- Use of STOCSY to highlight structurally linked signals
- Querying public NMR databases to support metabolite identification

Together, these tools streamline the exploration, interpretation, and annotation of complex spectral datasets.

## Citation
To cite the `metabom8` package in publications, use:

```{r citation, echo=FALSE, results='asis'}
citation("metabom8")
```

## Session Info
```{r session-info, echo=FALSE}
sessionInfo()
```

