name: BiocCheck

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  bioccheck:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      # Install BiocCheck (and cache deps)
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          needs: check
          extra-packages: |
            bioc::BiocCheck
            any::desc
            local::.

      # Build a source tarball (vignettes + no manual is fine)
      - name: Build tarball
        run: |
          R CMD build . --no-manual
          echo "PKG_TGZ=$(ls -1t *.tar.gz | head -n1)" >> $GITHUB_ENV

      # Run BiocCheck on the tarball; fail job only on ERRORs
      - name: Run BiocCheck
        run: |
          R -q -e 'BiocCheck::BiocCheck(Sys.getenv("PKG_TGZ"), `quit-with-status` = TRUE)'

      # (Optional) Upload artifacts for review
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bioccheck-artifacts
          path: |
            *.tar.gz
